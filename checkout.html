<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Thanh toán</title>
    <link rel="stylesheet" href="admin-ui/vendors/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="admin-ui/assets/css/style.css" />
    <style>
        .order-summary { border-radius:8px; background:#f6f7f9; padding:16px; }
        .cart-item td { vertical-align: middle; }
        .totals .label { color:#555; }
        .totals .value { font-weight:700; }
        .grand-total .value{ font-size:1.15rem; font-weight:800; }
    </style>
</head>
<body class="bg-dark">
    <div class="container py-5">
        <div class="text-center mb-4">
            <a href="index.php"><img src="admin-ui/images/logo.png" alt="Logo" style="max-height:56px;"></a>
        </div>
        <div class="row justify-content-center">
            <div class="col-lg-7">
                <div class="card p-4">
                    <h3 class="mb-3">Thông tin giao hàng</h3>
                    <form id="checkoutForm" onsubmit="return false;">
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>Họ & Tên đệm</label>
                                <input id="firstName" class="form-control" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label>Tên</label>
                                <input id="lastName" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input id="email" type="email" class="form-control" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>Số điện thoại</label>
                                <input id="phoneNumber" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Địa chỉ nhận hàng</label>
                            <input id="address" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label>Phương thức thanh toán</label>
                            <select id="paymentMethod" class="form-control">
                                <option value="paypal">PayPal</option>
                                <option value="cod">Thanh toán khi nhận hàng</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ghi chú</label>
                            <textarea id="addressNote" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="form-group form-check">
                            <input id="agreeTerms" type="checkbox" class="form-check-input">
                            <label class="form-check-label">Tôi đồng ý với <a href="terms.html" target="_blank">Điều khoản &amp; Dịch vụ</a></label>
                        </div>
                        <div class="d-flex">
                            <button id="backToCart" class="btn btn-light mr-2">Quay lại giỏ</button>
                            <button id="proceedBtn" class="btn btn-primary">Tiến hành thanh toán</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="order-summary">
                    <h5>Đơn hàng</h5>
                    <div class="table-responsive">
                        <table class="table table-borderless table-sm mb-2" id="cartTable">
                            <thead>
                                <tr>
                                    <th>Sản phẩm</th>
                                    <th class="text-center" style="width:8%">SL</th>
                                    <th class="text-right" style="width:20%">Đơn giá</th>
                                    <th class="text-right" style="width:20%">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody id="cartTableBody"></tbody>
                        </table>
                    </div>
                    <hr>
                    <div class="form-group">
                        <label>Phương thức vận chuyển</label>
                        <select id="shippingMethod" class="form-control form-control-sm">
                            <option value="0">Chọn vận chuyển (Miễn phí)</option>
                            <option value="5">Chuẩn - $5.00</option>
                            <option value="10">Nhanh - $10.00</option>
                        </select>
                    </div>
                    <div class="totals">
                        <div class="d-flex justify-content-between"><div class="label">Tạm tính</div><div class="value" id="subtotalText">$0.00</div></div>
                        <div class="d-flex justify-content-between"><div class="label">Phí vận chuyển</div><div class="value" id="shippingText">$0.00</div></div>
                        <div class="d-flex justify-content-between"><div class="label">Thuế</div><div class="value" id="taxText">$0.00</div></div>
                        <div class="d-flex justify-content-between mt-2 grand-total"><div class="label">Tổng</div><div class="value" id="totalText">$0.00</div></div>
                    </div>
                    <div id="paymentResult" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Checkout page script: reads localStorage.checkoutCart, allows edits, computes totals,
        // saves snapshot to localStorage.checkoutOrder and proceeds with payment or COD.
        // Default backend API base: http://<host>:8000/api — override with `window.BACKEND_BASE` if set.
        (function(){
            const DEFAULT_PORT = 8000;
            const host = location.hostname || 'localhost';
            const proto = location.protocol || 'http:';
            const configured = (window.BACKEND_BASE && String(window.BACKEND_BASE).replace(/\/$/, '')) || null;
            if (configured) window.__BACKEND_BASE = configured.replace(/\/$/, '');
            else window.__BACKEND_BASE = proto + '//' + host + ':' + DEFAULT_PORT + '/api';
        })();
        const backendBase = window.__BACKEND_BASE || '/api';

        // Robust token retrieval: check multiple keys in localStorage/sessionStorage and cookies
        function getAuthToken(){
            const keys = ['token','jwtToken','jwt','accessToken','authToken'];
            try{
                for(const k of keys){
                    try{ const v = localStorage.getItem(k); if (v) return v; }catch(e){}
                    try{ const v2 = sessionStorage.getItem(k); if (v2) return v2; }catch(e){}
                }
            }catch(e){}
            // check cookies like token=..., jwtToken=... or Authorization=Bearer ...
            try{
                if (document.cookie){
                    const parts = document.cookie.split(';').map(c=>c.trim());
                    for(const p of parts){
                        for(const k of keys){ if (p.startsWith(k+'=')) return decodeURIComponent(p.substring(k.length+1)); }
                        if (p.startsWith('Authorization=')){
                            const val = decodeURIComponent(p.substring('Authorization='.length));
                            if (val.startsWith('Bearer ')) return val.substring(7);
                            return val;
                        }
                    }
                }
            }catch(e){}
            return '';
        }
        const token = getAuthToken();
        let cartItems = [];

        const moneyFmt = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
        function formatMoney(n){ try{ return moneyFmt.format(Number(n)||0); }catch(e){ return String(Number(n||0)); } }
        function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;"}[c])); }

        function saveCheckoutCart(){ try{ localStorage.setItem('checkoutCart', JSON.stringify({ items: cartItems, savedAt: Date.now() })); }catch(e){ console.warn('saveCheckoutCart error', e); } }

        function renderCart(){
            const tbody = document.getElementById('cartTableBody'); tbody.innerHTML = '';
            cartItems.forEach((it, idx)=>{
                const tr = document.createElement('tr');
                const rawName = it.name || it.bookname || it.title || 'Sản phẩm';
                const name = escapeHtml(rawName);
                const qty = Number(it.quantity||it.qty||1);
                const unit = Number(it.unitPrice||it.price||0);
                // attach data attributes for consumer scripts: data-bookname and data-bookid
                try{ tr.dataset.bookname = String(rawName); }catch(e){}
                try{ tr.dataset.bookid = String(it.id || it.bookId || it.bookid || ''); }catch(e){}
                tr.innerHTML = '<td>'+name+'</td>'+
                             '<td class="text-center">'+qty+'</td>'+
                             '<td class="text-right">'+formatMoney(unit)+'</td>'+
                             '<td class="text-right" data-subtotal>'+formatMoney(qty*unit)+'</td>';
                tbody.appendChild(tr);
            });
            // quantities are fixed on checkout page (non-editable), so no listeners here
        }

        function computeTotals(){
            let subtotal = 0;
            cartItems.forEach(i=>{ subtotal += Number(i.quantity||i.qty||1) * Number(i.unitPrice||i.price||0); });
            // keep cents precision: round subtotal to cents
            subtotal = Math.round(subtotal * 100) / 100;
            const shipEl = document.getElementById('shippingMethod');
            const ship = shipEl ? Number(shipEl.value || 0) : 0;
            // tax = 10% rounded to nearest cent
            const tax = Math.round(subtotal * 0.1 * 100) / 100;
            // total rounded to cents
            const total = Math.round((subtotal + ship + tax) * 100) / 100;
            document.getElementById('subtotalText').innerText = formatMoney(subtotal);
            document.getElementById('shippingText').innerText = formatMoney(ship);
            document.getElementById('taxText').innerText = formatMoney(tax);
            document.getElementById('totalText').innerText = formatMoney(total);
            return { subtotal, ship, tax, total };
        }

        function showPaymentError(msg, debug){ const el = document.getElementById('paymentResult'); el.innerHTML = '<div class="alert alert-danger">'+escapeHtml(msg)+'</div>'; if(debug) console.error(debug); }

        document.addEventListener('DOMContentLoaded', ()=>{
            // load saved cart from localStorage.checkoutCart
            try{
                const saved = JSON.parse(localStorage.getItem('checkoutCart') || 'null');
                if (saved && Array.isArray(saved.items) && saved.items.length>0){
                    cartItems = saved.items.map(it => ({
                        bookId: it.id || null,
                        bookname: it.bookname || it.bookName || it.name || '',
                        name: it.name || it.bookname || it.bookName || '',
                        quantity: Number(it.quantity||it.qty||1),
                        unitPrice: Number(it.unitPrice||it.price||0),
                        price: Number(it.unitPrice||it.price||0),
                        subtotal: Number(it.subtotal) || (Number(it.unitPrice||it.price||0) * Number(it.quantity||1)),
                        image: it.image || it.img || it.imageUrl || null
                    }));
                } else { cartItems = cartItems || []; }
            }catch(e){ console.warn('checkout load saved error', e); cartItems = cartItems || []; }

            // Prefill buyer form from localStorage.userData, but prefer existing checkoutOrder.buyer if present
            try{
                const storedUser = JSON.parse(localStorage.getItem('userData') || 'null');
                const savedOrder = JSON.parse(localStorage.getItem('checkoutOrder') || 'null');
                const buyerSource = (savedOrder && savedOrder.buyer) ? savedOrder.buyer : storedUser;
                if(buyerSource){
                    const f = (v,t)=>{ try{ return (v!==undefined && v!==null) ? v : (t||''); }catch(e){return '';} };
                    document.getElementById('firstName').value = f(buyerSource.firstName || buyerSource.first_name || '');
                    document.getElementById('lastName').value = f(buyerSource.lastName || buyerSource.last_name || '');
                    document.getElementById('email').value = f(buyerSource.email || '');
                    document.getElementById('phoneNumber').value = f(buyerSource.phoneNumber || buyerSource.phone || buyerSource.phone_number || '');
                    document.getElementById('address').value = f(buyerSource.address || '');
                    // if savedOrder has a note, prefer it
                    if(savedOrder && savedOrder.buyer && savedOrder.buyer.addressNote){ document.getElementById('addressNote').value = savedOrder.buyer.addressNote; }
                }
            }catch(e){ console.warn('prefill userData error', e); }

            renderCart(); computeTotals();

            const shipEl = document.getElementById('shippingMethod'); if(shipEl) shipEl.addEventListener('change', ()=> computeTotals());

            document.getElementById('backToCart').addEventListener('click', (e)=>{ e.preventDefault(); window.location.href = 'cartbook.php'; });

            document.getElementById('proceedBtn').addEventListener('click', async ()=>{
                const totals = computeTotals();
                if(!document.getElementById('agreeTerms').checked){ alert('Vui lòng đồng ý với Điều khoản & Dịch vụ'); return; }
                const buyer = {
                    firstName: document.getElementById('firstName').value || '',
                    lastName: document.getElementById('lastName').value || '',
                    email: document.getElementById('email').value || '',
                    phoneNumber: document.getElementById('phoneNumber').value || '',
                    address: document.getElementById('address').value || '',
                    addressNote: document.getElementById('addressNote').value || '',
                };
                try{ localStorage.setItem('checkoutOrder', JSON.stringify({ buyer, items: cartItems, totals, savedAt: Date.now() })); }catch(e){ console.warn('save checkoutOrder', e); }

                const pm = document.getElementById('paymentMethod').value;
                if(pm === 'paypal'){
                    try{
                        // disable button + show waiting cursor
                        const btn = document.getElementById('proceedBtn'); btn.disabled = true; btn.innerText = 'Đang chuyển...';
                        document.getElementById('paymentResult').innerHTML = '';
                        document.body.style.cursor = 'wait';

                        // Build headers (include Authorization if available) and Idempotency-Key
                        const headers = { 'Content-Type': 'application/json' };
                        if (token) headers['Authorization'] = 'Bearer ' + token;
                        // Idempotency: reuse saved key for this cart if present
                        function uuidv4(){ if(window.crypto && crypto.randomUUID) return crypto.randomUUID(); try{ return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=='x'?r:(r&0x3|0x8);return v.toString(16);}); }catch(e){return Date.now() + '-' + Math.random().toString(36).slice(2,9);} }
                        const savedKeyKey = 'checkout_idempotency';
                        let idempotency = localStorage.getItem(savedKeyKey) || null;
                        if (!idempotency) { idempotency = uuidv4(); try{ localStorage.setItem(savedKeyKey, idempotency); }catch(e){} }
                        headers['Idempotency-Key'] = idempotency;

                        // Include optional image field taken from localStorage key 'image'
                        let topImage = null;
                        try {
                            const imgKey = localStorage.getItem('image');
                            if (imgKey) topImage = imgKey;
                            else {
                                const saved = JSON.parse(localStorage.getItem('checkoutCart') || 'null');
                                if (saved && Array.isArray(saved.items) && saved.items.length) {
                                    topImage = saved.items[0].image || null;
                                }
                            }
                        } catch (e) { topImage = null; }

                        const payload = { provider: 'paypal', items: cartItems, subtotal: totals.subtotal, shipping: totals.ship, tax: totals.tax, total: totals.total, buyer };
                        if (topImage) payload.image = topImage;

                        const res = await fetch(backendBase + '/payments/create', { method:'POST', headers, body: JSON.stringify(payload) });
                        document.body.style.cursor = 'default';
                        btn.disabled = false; btn.innerText = 'Tiến hành thanh toán';

                        let data = null;
                        try{ data = await res.json(); }catch(e){ /* ignore parse error */ }

                        if (!res.ok) {
                            // show server status or body error
                            const txt = data && (data.errMessage || data.message) ? (data.errMessage || data.message) : ('HTTP ' + res.status);
                            throw new Error('Server: ' + txt);
                        }

                        // Prefer semantic errCode check (backend often returns errCode)
                        if (data && (data.errCode === 0) && (data.approvalUrl || data.paymentUrl || data.redirectUrl)) {
                            // Clear idempotency key on success redirect (optional)
                            try{ localStorage.removeItem(savedKeyKey); }catch(e){}
                            window.location.href = data.paymentUrl || data.approvalUrl || data.redirectUrl;
                            return;
                        }

                        // Some backends return errCode in body even with 200; handle that
                        if (data && (data.approvalUrl || data.paymentUrl || data.redirectUrl)) {
                            window.location.href = data.paymentUrl || data.approvalUrl || data.redirectUrl;
                            return;
                        }

                        // fallback: show error details
                        const em = (data && (data.errMessage || data.message)) || JSON.stringify(data) || 'Không thể khởi tạo thanh toán. Vui lòng thử lại sau.';
                        showPaymentError(em, data);
                    }catch(err){ document.body.style.cursor = 'default'; showPaymentError('Lỗi khởi tạo thanh toán. Vui lòng thử lại.', err); }
                    return;
                }
                if(pm === 'cod'){
                    try{
                        const res = await fetch(backendBase + '/orders/create', { method:'POST', headers: Object.assign({'Content-Type':'application/json'}, token?{'Authorization':'Bearer '+token}:{ }), body: JSON.stringify({ paymentMethod:'cod', items: cartItems, total: totals.total, buyer }) });
                        let data = null;
                        try{ data = await res.json(); }catch(e){ data = null; }

                        if (!res.ok) {
                            const em = (data && (data.errMessage || data.message)) || ('HTTP ' + res.status);
                            throw new Error(em);
                        }

                        // Save server order id to localStorage (optional) and redirect to return page
                        const serverOrderId = (data && (data.id || data.orderId || data.order_id)) ? (data.id || data.orderId || data.order_id) : '';
                        try{ localStorage.setItem('lastOrderId', serverOrderId); }catch(e){}

                        // Attempt to clear temporary cart on backend (use special flag 'ALL')
                        try{
                            const userObj = JSON.parse(localStorage.getItem('userData') || 'null');
                            const userIdToSend = (userObj && userObj.id) ? userObj.id : '';
                            const delHeaders = Object.assign({'Content-Type':'application/json'}, token ? { 'Authorization': 'Bearer ' + token } : {});
                            const delRes = await fetch(backendBase + '/delete-cartitem', { method: 'POST', headers: delHeaders, body: JSON.stringify({ cartItemId: 'ALL', userId: userIdToSend }) });
                            try{ const delData = await delRes.json().catch(()=>null); if (!delRes.ok || (delData && delData.errCode && delData.errCode !== 0)) console.warn('delete-cartitem failed', delRes.status, delData); }catch(e){ console.warn('delete-cartitem parse error', e); }
                        }catch(e){ console.warn('delete-cartitem error', e); }

                        // Clear local storage cart snapshots
                        try{ localStorage.removeItem('checkoutCart'); localStorage.removeItem('checkoutOrder'); }catch(e){}

                        // Redirect to return page which will show confirmation and email notice
                        const url = 'return.php?status=success' + (serverOrderId ? '&orderId=' + encodeURIComponent(serverOrderId) : '');
                        window.location.href = url;
                        return;
                    }catch(err){ showPaymentError('Lỗi tạo đơn. Vui lòng thử lại.', err); }
                    return;
                }
                showPaymentError('Phương thức thanh toán không được hỗ trợ.');
            });
        });
    </script>

    <script src="admin-ui/vendors/jquery/dist/jquery.min.js"></script>
    <script src="admin-ui/vendors/popper.js/dist/umd/popper.min.js"></script>
    <script src="admin-ui/vendors/bootstrap/dist/js/bootstrap.min.js"></script>
</body>
</html>
