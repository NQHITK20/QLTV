<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Thanh toán</title>
    <link rel="stylesheet" href="admin-ui/vendors/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="admin-ui/assets/css/style.css" />
    <style>
        .order-summary { border-radius:8px; background:#f6f7f9; padding:16px; }
        .cart-item td { vertical-align: middle; }
        .totals .label { color:#555; }
        .totals .value { font-weight:700; }
        .grand-total .value{ font-size:1.15rem; font-weight:800; }
    </style>
</head>
<body class="bg-dark">
    <div class="container py-5">
        <div class="text-center mb-4">
            <a href="index.php"><img src="admin-ui/images/logo.png" alt="Logo" style="max-height:56px;"></a>
        </div>
        <div class="row justify-content-center">
            <div class="col-lg-7">
                <div class="card p-4">
                    <h3 class="mb-3">Thông tin giao hàng</h3>
                    <form id="checkoutForm" onsubmit="return false;">
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>Họ & Tên đệm</label>
                                <input id="firstName" class="form-control" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label>Tên</label>
                                <input id="lastName" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input id="email" type="email" class="form-control" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>Số điện thoại</label>
                                <input id="phoneNumber" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Địa chỉ nhận hàng</label>
                            <input id="address" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label>Phương thức thanh toán</label>
                            <select id="paymentMethod" class="form-control">
                                <option value="paypal">PayPal</option>
                                <option value="cod">Thanh toán khi nhận hàng</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ghi chú</label>
                            <textarea id="addressNote" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="form-group form-check">
                            <input id="agreeTerms" type="checkbox" class="form-check-input">
                            <label class="form-check-label">Tôi đồng ý với <a href="terms.html" target="_blank">Điều khoản &amp; Dịch vụ</a></label>
                        </div>
                        <div class="d-flex">
                            <button id="backToCart" class="btn btn-light mr-2">Quay lại giỏ</button>
                            <button id="proceedBtn" class="btn btn-primary">Tiến hành thanh toán</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="order-summary">
                    <h5>Đơn hàng</h5>
                    <div class="table-responsive">
                        <table class="table table-borderless table-sm mb-2" id="cartTable">
                            <thead>
                                <tr>
                                    <th>Sản phẩm</th>
                                    <th class="text-center" style="width:8%">SL</th>
                                    <th class="text-right" style="width:20%">Đơn giá</th>
                                    <th class="text-right" style="width:20%">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody id="cartTableBody"></tbody>
                        </table>
                    </div>
                    <hr>
                    <div class="form-group">
                        <label>Phương thức vận chuyển</label>
                        <select id="shippingMethod" class="form-control form-control-sm">
                            <option value="0">Chọn vận chuyển (Miễn phí)</option>
                            <option value="5">Chuẩn - $5.00</option>
                            <option value="10">Nhanh - $10.00</option>
                        </select>
                    </div>
                    <div class="totals">
                        <div class="d-flex justify-content-between"><div class="label">Tạm tính</div><div class="value" id="subtotalText">$0.00</div></div>
                        <div class="d-flex justify-content-between"><div class="label">Phí vận chuyển</div><div class="value" id="shippingText">$0.00</div></div>
                        <div class="d-flex justify-content-between"><div class="label">Thuế</div><div class="value" id="taxText">$0.00</div></div>
                        <div class="d-flex justify-content-between mt-2 grand-total"><div class="label">Tổng</div><div class="value" id="totalText">$0.00</div></div>
                    </div>
                    <div id="paymentResult" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Checkout page script: reads localStorage.checkoutCart, allows edits, computes totals,
        // saves snapshot to localStorage.checkoutOrder and proceeds with payment or COD.
        const backendBase = '/api';
        const token = localStorage.getItem('token') || '';
        let cartItems = [];

        const moneyFmt = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
        function formatMoney(n){ try{ return moneyFmt.format(Number(n)||0); }catch(e){ return String(Number(n||0)); } }
        function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;"}[c])); }

        function saveCheckoutCart(){ try{ localStorage.setItem('checkoutCart', JSON.stringify({ items: cartItems, savedAt: Date.now() })); }catch(e){ console.warn('saveCheckoutCart error', e); } }

        function renderCart(){
            const tbody = document.getElementById('cartTableBody'); tbody.innerHTML = '';
            cartItems.forEach((it, idx)=>{
                const tr = document.createElement('tr');
                const name = escapeHtml(it.name || it.bookname || it.title || 'Sản phẩm');
                const qty = Number(it.quantity||it.qty||1);
                const unit = Number(it.unitPrice||it.price||0);
                tr.innerHTML = '<td>'+name+'</td>'+
                             '<td class="text-center">'+qty+'</td>'+
                             '<td class="text-right">'+formatMoney(unit)+'</td>'+
                             '<td class="text-right" data-subtotal>'+formatMoney(qty*unit)+'</td>';
                tbody.appendChild(tr);
            });
            // quantities are fixed on checkout page (non-editable), so no listeners here
        }

        function computeTotals(){
            let subtotal = 0;
            cartItems.forEach(i=>{ subtotal += Number(i.quantity||i.qty||1) * Number(i.unitPrice||i.price||0); });
            // keep cents precision: round subtotal to cents
            subtotal = Math.round(subtotal * 100) / 100;
            const shipEl = document.getElementById('shippingMethod');
            const ship = shipEl ? Number(shipEl.value || 0) : 0;
            // tax = 10% rounded to nearest cent
            const tax = Math.round(subtotal * 0.1 * 100) / 100;
            // total rounded to cents
            const total = Math.round((subtotal + ship + tax) * 100) / 100;
            document.getElementById('subtotalText').innerText = formatMoney(subtotal);
            document.getElementById('shippingText').innerText = formatMoney(ship);
            document.getElementById('taxText').innerText = formatMoney(tax);
            document.getElementById('totalText').innerText = formatMoney(total);
            return { subtotal, ship, tax, total };
        }

        function showPaymentError(msg, debug){ const el = document.getElementById('paymentResult'); el.innerHTML = '<div class="alert alert-danger">'+escapeHtml(msg)+'</div>'; if(debug) console.error(debug); }

        document.addEventListener('DOMContentLoaded', ()=>{
            // load saved cart from localStorage.checkoutCart
            try{
                const saved = JSON.parse(localStorage.getItem('checkoutCart') || 'null');
                if (saved && Array.isArray(saved.items) && saved.items.length>0){
                    cartItems = saved.items.map(it => ({ id: it.id||'', name: it.name||'', quantity: Number(it.quantity||it.qty||1), unitPrice: Number(it.unitPrice||it.price||0), subtotal: Number(it.subtotal) || (Number(it.unitPrice||it.price||0) * Number(it.quantity||1)) }));
                } else { cartItems = cartItems || []; }
            }catch(e){ console.warn('checkout load saved error', e); cartItems = cartItems || []; }

            // Prefill buyer form from localStorage.userData, but prefer existing checkoutOrder.buyer if present
            try{
                const storedUser = JSON.parse(localStorage.getItem('userData') || 'null');
                const savedOrder = JSON.parse(localStorage.getItem('checkoutOrder') || 'null');
                const buyerSource = (savedOrder && savedOrder.buyer) ? savedOrder.buyer : storedUser;
                if(buyerSource){
                    const f = (v,t)=>{ try{ return (v!==undefined && v!==null) ? v : (t||''); }catch(e){return '';} };
                    document.getElementById('firstName').value = f(buyerSource.firstName || buyerSource.first_name || '');
                    document.getElementById('lastName').value = f(buyerSource.lastName || buyerSource.last_name || '');
                    document.getElementById('email').value = f(buyerSource.email || '');
                    document.getElementById('phoneNumber').value = f(buyerSource.phoneNumber || buyerSource.phone || buyerSource.phone_number || '');
                    document.getElementById('address').value = f(buyerSource.address || '');
                    // if savedOrder has a note, prefer it
                    if(savedOrder && savedOrder.buyer && savedOrder.buyer.addressNote){ document.getElementById('addressNote').value = savedOrder.buyer.addressNote; }
                }
            }catch(e){ console.warn('prefill userData error', e); }

            renderCart(); computeTotals();

            const shipEl = document.getElementById('shippingMethod'); if(shipEl) shipEl.addEventListener('change', ()=> computeTotals());

            document.getElementById('backToCart').addEventListener('click', (e)=>{ e.preventDefault(); window.location.href = 'cartbook.php'; });

            document.getElementById('proceedBtn').addEventListener('click', async ()=>{
                const totals = computeTotals();
                if(!document.getElementById('agreeTerms').checked){ alert('Vui lòng đồng ý với Điều khoản & Dịch vụ'); return; }
                const buyer = {
                    firstName: document.getElementById('firstName').value || '',
                    lastName: document.getElementById('lastName').value || '',
                    email: document.getElementById('email').value || '',
                    phoneNumber: document.getElementById('phoneNumber').value || '',
                    address: document.getElementById('address').value || '',
                    addressNote: document.getElementById('addressNote').value || '',
                };
                try{ localStorage.setItem('checkoutOrder', JSON.stringify({ buyer, items: cartItems, totals, savedAt: Date.now() })); }catch(e){ console.warn('save checkoutOrder', e); }

                const pm = document.getElementById('paymentMethod').value;
                if(pm === 'paypal'){
                    try{
                        document.getElementById('paymentResult').innerHTML = '';
                        document.body.style.cursor = 'wait';
                        const res = await fetch(backendBase + '/payments/create', { method:'POST', headers: Object.assign({'Content-Type':'application/json'}, token?{'Authorization':'Bearer '+token}:{ }), body: JSON.stringify({ provider:'paypal', items: cartItems, total: totals.total, buyer }) });
                        document.body.style.cursor = 'default';
                        if(!res.ok){ const txt = await res.text().catch(()=>''); throw new Error('Server: '+res.status+' '+txt); }
                        const data = await res.json();
                        if(data && (data.paymentUrl||data.approvalUrl||data.redirectUrl)){ window.location.href = data.paymentUrl||data.approvalUrl||data.redirectUrl; }
                        else showPaymentError('Không thể khởi tạo thanh toán. Vui lòng thử lại sau.', data);
                    }catch(err){ document.body.style.cursor = 'default'; showPaymentError('Lỗi khởi tạo thanh toán. Vui lòng thử lại.', err); }
                    return;
                }
                if(pm === 'cod'){
                    try{
                        const res = await fetch(backendBase + '/orders/create', { method:'POST', headers: Object.assign({'Content-Type':'application/json'}, token?{'Authorization':'Bearer '+token}:{ }), body: JSON.stringify({ paymentMethod:'cod', items: cartItems, total: totals.total, buyer }) });
                        const data = await res.json();
                        document.getElementById('paymentResult').innerHTML = '<div class="alert alert-success">Đơn hàng đã được tạo (COD). Mã: '+(data.id||'')+'</div>';
                    }catch(err){ showPaymentError('Lỗi tạo đơn. Vui lòng thử lại.', err); }
                    return;
                }
                showPaymentError('Phương thức thanh toán không được hỗ trợ.');
            });
        });
    </script>

    <script src="admin-ui/vendors/jquery/dist/jquery.min.js"></script>
    <script src="admin-ui/vendors/popper.js/dist/umd/popper.min.js"></script>
    <script src="admin-ui/vendors/bootstrap/dist/js/bootstrap.min.js"></script>
</body>
</html>
