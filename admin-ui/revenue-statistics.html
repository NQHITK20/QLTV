<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Quản lý thư viện</title>
    <meta name="description" content="Quản lý thư viện - HTML5 Admin Template" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="apple-touch-icon" href="apple-icon.png" />
    <link rel="shortcut icon" href="favicon.ico" />

    <link rel="stylesheet" href="vendors/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="vendors/font-awesome/css/font-awesome.min.css" />
    <link rel="stylesheet" href="vendors/themify-icons/css/themify-icons.css" />
    <link rel="stylesheet" href="vendors/flag-icon-css/css/flag-icon.min.css" />
    <link rel="stylesheet" href="vendors/selectFX/css/cs-skin-elastic.css" />
    <link rel="stylesheet" href="vendors/jqvmap/dist/jqvmap.min.css" />

    <link rel="stylesheet" href="assets/css/style.css" />

    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800" rel="stylesheet" type="text/css" />
    <style>
        /* Revenue card: vertical layout, left aligned, no responsiveness needed */
        .revenue-card-body {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            box-sizing: border-box;
            width: 640px; /* fixed width, not responsive */
        }
        .revenue-card-body .controls {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 6px;
        }
        .revenue-card-body .controls label {
            font-size: 13px;
            margin: 0 0 2px 0;
        }
        .revenue-card-body .controls select {
            min-width: 160px;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #fff;
        }
        .revenue-card-body .chart-wrapper {
            width: 600px; /* fixed */
            height: 320px; /* fixed */
            border: 0;
        }
        .revenue-card-body canvas { display:block; }
        /* Center the small stat widget and improve appearance */
        .revenue-card-body .stat-widget-one {
            margin: 8px auto; /* center horizontally inside the controls column */
            display: flex;
            align-items: center;
            gap: 10px;
            background: #ffffff;
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        }
        .revenue-card-body .stat-widget-one .stat-text { font-size: 13px; color: #666; }
        .revenue-card-body .stat-widget-one .stat-digit { font-size: 18px; font-weight: 600; color: #2d8cf0; }
    </style>
</head>

<body>
    <div class="overlay" id="loadingOverlay">
        <div class="spinner-border text-light" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
    <!-- Left Panel -->

    <aside id="left-panel" class="left-panel">
        <nav class="navbar navbar-expand-sm navbar-default">
            <div class="navbar-header">
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-menu"
                    aria-controls="main-menu" aria-expanded="false" aria-label="Toggle navigation">
                    <i class="fa fa-bars"></i>
                </button>
                <a class="navbar-brand" href="../index.php"><img src="images/logo.png" alt="Logo" /></a>
                <a class="navbar-brand hidden" href="./"><img src="images/logo2.png" alt="Logo" /></a>
            </div>

            <div id="main-menu" class="main-menu collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li class="active">
                        <a href="index.html">
                            <i class="menu-icon fa fa-dashboard"></i>Dashboard
                        </a>
                    </li>
                    <h3 class="menu-title">Các mục chính</h3>
                    <!-- /.menu-title -->
                    <li class="menu-item-has-children dropdown hidden-user">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"
                            aria-expanded="false">
                            <i class="menu-icon fa fa-user"></i>Tài khoản</a>
                        <ul class="sub-menu children dropdown-menu">
                            <li>
                                <i class="fa fa-user"></i><a href="manage-user.php">Quản lý tài khoản</a>
                            </li>
                            <li>
                                <i class="fa fa-plus"></i><a href="add-user.html">Thêm tài khoản</a>
                            </li>
                        </ul>
                    </li>
                    <li class="menu-item-has-children dropdown hidden-user">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"
                            aria-expanded="false">
                            <i class="menu-icon fa fa fa-file-text-o"></i>Bài viết</a>
                        <ul class="sub-menu children dropdown-menu">
                            <li>
                                <i class="fa fa-file-text-o"></i><a href="manage-content.php">Quản lý bài viết</a>
                            </li>
                            <li>
                                <i class="fa fa-plus"></i><a href="add-content.html">Thêm bài viết</a>
                            </li>
                        </ul>
                    </li>
                    <li class="menu-item-has-children dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"
                            aria-expanded="false">
                            <i class="menu-icon fa fa-book"></i>Sách</a>
                        <ul class="sub-menu children dropdown-menu">
                            <li>
                                <i class="fa fa-book"></i><a href="manage-book.php">Quản lý sách</a>
                            </li>
                            <li>
                                <i class="fa fa-plus"></i><a href="add-book.html">Thêm sách</a>
                            </li>
                        </ul>
                    </li>
                    <li class="menu-item-has-children dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"
                            aria-expanded="false">
                            <i class="menu-icon fa fa-tags"></i>Danh mục
                            sách</a>
                        <ul class="sub-menu children dropdown-menu">
                            <li>
                                <i class="fa fa-tags"></i><a href="manage-category.php">Quản lý danh mục</a>
                            </li>
                            <li>
                                <i class="fa fa-plus"></i><a href="add-category.html">Thêm danh mục</a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </nav>
    </aside>
    <!-- /#left-panel -->

    <!-- Left Panel -->

    <!-- Right Panel -->

    <div id="right-panel" class="right-panel">
        <!-- Header-->
        <header id="header" class="header">
            <div class="header-menu">
                <div class="col-sm-7">
                    <a id="menuToggle" class="menutoggle pull-left"><i class="fa fa fa-tasks"></i></a>
                </div>

                <div class="col-sm-5">
                    <div class="user-area dropdown float-right">
                        <span id="span-avatar"></span>
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"
                            aria-expanded="false">
                            <img class="user-avatar rounded-circle" src="images/admin.jpg" alt="User Avatar" />
                        </a>
                        <div class="user-menu dropdown-menu">
                            <a class="nav-link" href="page-login.html" onclick="logout()"><i class="fa fa-sign-out"></i>
                                Đăng xuất
                            </a>
                            <a class="nav-link" href="../index.php"><i class="fa fa-newspaper-o"></i> Về trang
                                chủ
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- /header -->
        <!-- Header-->

        <div class="breadcrumbs">
            <div class="col-sm-4">
                <div class="page-header float-left">
                    <div class="page-title">
                        <h1>Doanh thu</h1>
                    </div>
                </div>
            </div>
            <div class="col-sm-8">
                <div class="page-header float-right">
                    <div class="page-title">
                        <ol class="breadcrumb text-right">
                            <li>Đơn hàng</li>
                            <li class="active">Thống kê doanh thu</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <div class="content mt-3">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <strong>Thống kê doanh thu</strong>
                    </div>

                    <div class="card-body card-block py-4 revenue-card-body">
                        <div class="controls">
                            <div>
                                <label for="selView">Xem theo</label><br>
                                <select id="selView">
                                    <option value="year">Năm</option>
                                    <option value="month">Tháng</option>
                                </select>
                            </div>
                            <div>
                                <label for="selYear">Năm</label><br>
                                <select id="selYear">
                                    <!-- years: current and previous 4 -->
                                </select>
                            </div>
                            <div id="monthWrapper">
                                <label for="selMonth">Tháng</label><br>
                                <select id="selMonth">
                                    <option value="0">Tất cả</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                </select>
                            </div>
                            <!-- week selector removed -->
                            <div class="stat-widget-one">
                                <div class="stat-icon dib"><i class="ti-money text-success border-success"></i></div>
                                <div class="stat-content dib">
                                    <div class="stat-text">Tổng doanh thu</div>
                                    <div class="stat-digit">1,012</div>
                                </div>
                            </div>
                        </div>

                        <div class="chart-wrapper">
                            <canvas id="revenueChart" width="995" height="320"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- .content -->
    </div>
    <!-- /#right-panel -->

    <!-- Right Panel -->
    <script src="vendors/jquery/dist/jquery.min.js"></script>
    <script src="vendors/popper.js/dist/umd/popper.min.js"></script>
    <script src="vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="vendors/chart.js/dist/Chart.bundle.min.js"></script>
    <!-- Page-specific chart init for revenue (no animation, not responsive) -->
    <script>
        (function(){
            try {
                // populate year select (current year and previous 4)
                var selYear = document.getElementById('selYear');
                var now = new Date();
                var cy = now.getFullYear();
                // include 2026 explicitly
                try {
                    var opt2026 = document.createElement('option'); opt2026.value = 2026; opt2026.text = 2026; selYear.appendChild(opt2026);
                } catch (e) { /* ignore */ }
                // only show current year and the previous 2 years (3 years total)
                for (var y = cy; y >= cy-2; y--) {
                    var opt = document.createElement('option'); opt.value = y; opt.text = y; selYear.appendChild(opt);
                }
                // default values
                selYear.value = cy;
                document.getElementById('selMonth').value = 0;
                // view select and week wrapper handling
                var selView = document.getElementById('selView');
                var monthWrapper = document.getElementById('monthWrapper');
                function updateViewUI() {
                    if (selView.value === 'month') {
                        // Monthly view: show month selector
                        monthWrapper.style.display = 'block';
                    } else {
                        // Yearly view: hide month selector
                        monthWrapper.style.display = 'none';
                    }
                }
                updateViewUI();
                updateViewUI();

                if (typeof Chart === 'undefined') { console.error('Chart.js not loaded'); return; }
                var canvas = document.getElementById('revenueChart');
                if (!canvas) { console.warn('Canvas #revenueChart not found'); return; }

                // Always show 12 months
                var labels = ['Tháng 1','Tháng 2','Tháng 3','Tháng 4','Tháng 5','Tháng 6','Tháng 7','Tháng 8','Tháng 9','Tháng 10','Tháng 11','Tháng 12'];
                // helper: generate n random positive numbers scaled to approx target total
                function generateScaled(n, target) {
                    var arr = [];
                    var total = 0;
                    for (var i=0;i<n;i++) { var v = Math.random(); arr.push(v); total += v; }
                    // avoid division by zero
                    if (total <= 0) total = 1;
                    var scaled = arr.map(function(v){ return Math.round((v/total) * target); });
                    // adjust rounding diff by adding/subtracting to first element
                    var sumScaled = scaled.reduce(function(s,x){ return s + x; }, 0);
                    var diff = target - sumScaled;
                    if (diff !== 0) scaled[0] = Math.max(0, scaled[0] + diff);
                    return scaled;
                }

                // sample data used as fallback while network fails
                var sampleData = generateScaled(12, 10000);

                // Chart.js 2.x style options to be compatible with bundled Chart
                var ctx = canvas.getContext('2d');
                window.revenueChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: labels, datasets: [{ label: 'Doanh thu', data: sampleData, backgroundColor: 'rgba(54,162,235,0.2)', borderColor: 'rgba(54,162,235,1)', borderWidth: 2, fill: true }]},
                    options: { responsive: false, animation: false, scales: { yAxes: [{ ticks: { beginAtZero: true } }] }, legend: { display: true } }
                });

                // Fetch real data from backend and update chart. The backend endpoint is protected by
                // checkAuth; we use POST (current server route) and include credentials (cookies).
                async function fetchAndUpdate() {
                    var view = selView.value;
                    var year = selYear.value;
                    var month = document.getElementById('selMonth').value || 0;
                    var url = 'http://localhost:8000/api/statistics/revenue?view=' + encodeURIComponent(view) + '&year=' + encodeURIComponent(year) + '&month=' + encodeURIComponent(month);
                    try {
                        var resp = await fetch(url, { method: 'POST', credentials: 'include', headers: { 'Accept': 'application/json' } });
                        if (!resp.ok) {
                            alert('Xin lỗi, không thể lấy dữ liệu thống kê. (HTTP ' + resp.status + ')');
                            return;
                        }
                        var json = await resp.json();
                        // prefer period totals (mốc nào ra mốc đấy), fallback to other keys
                        var totals = json.totals || json.dataStatistic || (json.datasets && json.datasets.total) || json.datasttic || [];
                        // set stat widget: show monthlyTotal when viewing month, else yearlyTotal
                        try {
                            var monthlyTotal = Number(json.monthlyTotal || 0) || 0;
                            var yearlyTotal = Number(json.yearlyTotal || 0) || 0;
                            var showVal = (view === 'month' && month && Number(month) >= 1) ? monthlyTotal : yearlyTotal;
                            // fallback: if showVal is zero but totals has values, use sum of totals
                            if ((!showVal || showVal === 0) && Array.isArray(totals) && totals.length) {
                                showVal = totals.reduce(function(s,x){ return s + (Number(x)||0); }, 0);
                            }
                            var el = document.querySelector('.stat-widget-one .stat-digit');
                            if (el) el.innerText = (Number(showVal) || 0).toLocaleString('en-US');
                        } catch (e) { /* ignore stat update errors */ }
                        // if month view the API returns 4 values (weeks); ensure labels accordingly
                        if (view === 'month') {
                            window.revenueChart.data.labels = ['Tuần 1','Tuần 2','Tuần 3','Tuần 4'];
                        } else {
                            window.revenueChart.data.labels = labels;
                        }

                        // If totals length mismatches chart labels, try to adapt (pad with zeros)
                        var targetLen = window.revenueChart.data.labels.length;
                        if (!Array.isArray(totals)) totals = [];
                        if (totals.length < targetLen) {
                            while (totals.length < targetLen) totals.push(0);
                        } else if (totals.length > targetLen) {
                            totals = totals.slice(0, targetLen);
                        }

                        var pointBackgrounds = totals.map(function(){ return 'rgba(54,162,235,0.9)'; });
                        if (view === 'month') {
                            // no per-week highlight after removing week selector
                        } else {
                            var selM = parseInt(document.getElementById('selMonth').value, 10) || 0;
                            if (selM >= 1 && selM <= 12) pointBackgrounds[selM-1] = 'rgba(255,99,132,0.9)';
                        }

                        var ds = window.revenueChart.data.datasets[0];
                        ds.data = totals;
                        ds.pointBackgroundColor = pointBackgrounds;
                        ds.pointBorderColor = ds.pointBackgroundColor;
                        window.revenueChart.update();

                        // show informational message when backend responds with a message
                        if (json.message) {
                            if (json.message.indexOf('Không có dữ liệu') !== -1) {
                                // show non-blocking info
                                console.info(json.message);
                            }
                        }
                    } catch (err) {
                        console.error('Fetch revenue error', err);
                        alert('Xin lỗi, đã xảy ra lỗi khi tải dữ liệu thống kê.');
                    }
                }

                // wire up controls to call API
                document.getElementById('selYear').addEventListener('change', fetchAndUpdate);
                document.getElementById('selMonth').addEventListener('change', fetchAndUpdate);
                selView.addEventListener('change', function(){ updateViewUI(); fetchAndUpdate(); });

                // initial load
                fetchAndUpdate();
            } catch (e) { console.error('revenue chart init error', e); }
        })();
    </script>
    <!-- Keep dashboard/widgets scripts if you want full admin dashboard elsewhere -->
    <script src="assets/js/dashboard.js"></script>
    <script src="assets/js/widgets.js"></script>
    <script src="vendors/jqvmap/dist/jquery.vmap.min.js"></script>
    <script src="vendors/jqvmap/examples/js/jquery.vmap.sampledata.js"></script>
    <script src="vendors/jqvmap/dist/maps/jquery.vmap.world.js"></script>
    <script src="assets/js/init-scripts/chart-js/chartjs-init.js"></script>
    <script>
        (function ($) {
            "use strict";
            jQuery("#vmap").vectorMap({
                map: "world_en",
                backgroundColor: null,
                color: "#ffffff",
                hoverOpacity: 0.7,
                selectedColor: "#1de9b6",
                enableZoom: true,
                showTooltip: true,
                values: sample_data,
                scaleColors: ["#1de9b6", "#03a9f5"],
                normalizeFunction: "polynomial",
            });
        })(jQuery);
        function logout() {
            localStorage.removeItem("userData");
            localStorage.removeItem("jwtToken");
        }

        // Safe init for user avatar / role usage to avoid runtime errors
        (function initUser() {
            let user = null;
            try { user = JSON.parse(localStorage.getItem('userData')); } catch (e) { user = null; }
            const span = document.getElementById('span-avatar');
            if (span) span.innerText = user && user.lastName ? ('Hi ' + user.lastName) : 'Hi';
            try {
                if (!user || String(user.roleId) !== '3') {
                    document.querySelectorAll('.hidden-user').forEach(el => el.style.display = 'none');
                }
            } catch (e) { }
        })();
    </script>
</body>
<style>
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 999;
    }
</style>

</html>
